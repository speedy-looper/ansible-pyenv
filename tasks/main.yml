---
- name: ensure bash_profile
  shell: touch ~/.bash_profile
  changed_when: False
  always_run: yes

- name: check if pyenv in PATH
  shell: . ~/.bash_profile && echo $PATH
  args:
    executable: /bin/bash
  register: paths
  changed_when: False
  always_run: yes

- name: download pyenv-install.sh
  get_url:
    url=https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer
    dest=/home/test/pyenv.sh
    mode=0744
  when: "'pyenv' not in paths.stdout"

- name: run the installer
  script: /home/test/pyenv.sh
  when: "'pyenv' not in paths.stdout"

- name: update PATH
  lineinfile:
    dest=~/.bash_profile
    line='export PATH="$HOME/.pyenv/bin:$PATH"'

- name: init pyenv with bash
  lineinfile:
    dest=~/.bash_profile
    line='eval "$(pyenv init -)"'

- name: pyenv update
  shell: . ~/.bash_profile && pyenv update
  args:
    executable: /bin/bash
  when: "'pyenv' not in paths.stdout"

- name: install python versions
  shell: . ~/.bash_profile && echo no | pyenv install {{ item }}
  args:
    executable: /bin/bash
  with_items: "{{ python.versions }}"

- name: set global python
  shell: . ~/.bash_profile && pyenv global {{ python.default }}
